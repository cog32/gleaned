"""
Copybara configuration for bidirectional sync between public gleaned and private gleaned-covid repositories.

Rules:
- Publicâ†’Private: Sync all files from public repo
- Privateâ†’Public: Only sync files that already exist in public repo
- Features directory: Only synced to public if it already exists there (prevents pushing BDD to non-BDD projects)
- Never sync .covid directory (private only)
- Never sync setup/config files from private to public
"""

# Configuration for syncing FROM public gleaned TO private gleaned-covid
public_to_private = core.workflow(
    name = "public_to_private",
    origin = git.github_origin(
        url = "https://github.com/cog32/gleaned.git",
        ref = "main",
    ),
    destination = git.github_destination(
        url = "https://github.com/cog32/gleaned-covid.git",
        push = "main",
    ),
    origin_files = glob(["**"], exclude = [
        # Exclude git files
        ".git/**",
        # Any other files we don't want to sync
    ]),
    destination_files = glob(["**"], exclude = [
        # Never overwrite the .covid directory
        ".covid/**",
        # Never overwrite private-only files
        "copy.bara.sky",
        "sync-scripts.sh",
        "setup-private-repo.sh",
        "copybara",
        "template.json",
        "template-setup.md",
        "AGENTS.md",
        "CLAUDE.md",
        "LOCAL_EXECUTION.md",
    ]),
    authoring = authoring.overwrite("Copybara <noreply@copybara.com>"),
    transformations = [
        metadata.squash_notes(
            prefix = "ðŸ”„ Synced from public gleaned repo\n\n",
        ),
    ],
)

# Configuration for syncing FROM private gleaned-covid TO public gleaned
# Features will only be synced if they already exist in the destination
private_to_public = core.workflow(
    name = "private_to_public",
    origin = git.github_origin(
        url = "https://github.com/cog32/gleaned-covid.git",
        ref = "main",
    ),
    # Open a Pull Request against the public repo instead of pushing to main
    destination = git.github_pr_destination(
        url = "https://github.com/cog32/gleaned.git",
        destination_ref = "main",
        # Omit pr_branch to let Copybara generate a unique branch per run
    ),
    origin_files = glob(["**"], exclude = [
        # Never sync private-only directories
        ".covid/**",
        ".git/**",
        # Don't sync copybara config and setup files
        "copy.bara.sky",
        "sync-scripts.sh",
        "setup-private-repo.sh",
        "copybara",
        "template.json",
        "template-setup.md",
        # One-way sync: git config files only go publicâ†’private, not privateâ†’public
        ".gitattributes",
        ".gitignore",
        ".gitmodules",
    ]),
    destination_files = glob(["**"], exclude = [
        ".git/**",
    ]),
    authoring = authoring.overwrite("Copybara <noreply@copybara.com>"),
    transformations = [
        # If a CLI label 'release_title' is provided (accessible as
        # ${FLAG_RELEASE_TITLE}), set the commit/PR message to use it as the
        # title and keep the existing message as the body. If the label is not
        # present, this transform is a no-op.
        metadata.replace_message(
            "${FLAG_RELEASE_TITLE}\n\n${COPYBARA_CURRENT_MESSAGE}",
            ignore_label_not_found = True,
        ),
        # If a CLI label 'issue' is provided (accessible as ${FLAG_ISSUE}),
        # append an auto-linking close directive to the PR body so the PR
        # references (and closes) the corresponding GitHub issue on merge.
        metadata.replace_message(
            "${COPYBARA_CURRENT_MESSAGE}\n\nCloses #${FLAG_ISSUE}",
            ignore_label_not_found = True,
        ),
    ],
    # Use SQUASH for a single-commit PR (cleaner history)
    mode = "SQUASH",
)
