#!/usr/bin/env bash
set -euo pipefail

export CI=1

echo "[pre-push] Running quick test gateâ€¦"

fail() {
  echo "[pre-push] ERROR: $1" >&2
  exit 1
}

# Fast suites first
if [ -x "scripts/run_unit_tests.sh" ]; then
  ./scripts/run_unit_tests.sh || fail "Unit tests failed"
else
  echo "[pre-push] run_unit_tests.sh missing; falling back to npm test"
  npm test || fail "Unit tests failed"
fi

if [ -x "scripts/run_feature_tests.sh" ]; then
  ./scripts/run_feature_tests.sh || fail "BDD tests failed"
fi

# E2E gate runs and is required
if [ -x "scripts/run_e2e_tests.sh" ]; then
  ./scripts/run_e2e_tests.sh || fail "E2E tests failed"
else
  fail "E2E script not found (scripts/run_e2e_tests.sh)"
fi

echo "[pre-push] OK"
